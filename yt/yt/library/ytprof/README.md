# ytprof

## CPU профайлер

YTProf содержит реализацию CPU профайлера, похожую на `runtime/pprof` из golang.

В отличии от google perf tools, библиотека пишет self contained профиль
в протобуф формате, с информацией о символах внутри. Это значит,
что записанный профиль можно просматривать без доступа к исходному исполняемому
файлу. При этом, если исходный исполняемый файл всё же есть, то информация о символах
будет браться из него и будет более точной.

YTProf поддерживает теги. `TCpuProfilerTagGuard` кладёт тег в TLS треда, а профайлер
сохраняет этот тег в семпл. Теги позволяют фильтровать профиль в pprof с помощью команды
`tagfocus`. Например, можно положить в тег тип запроса или имя текущего пользователя.

### Известные ограничения

- Не работает с `--musl`. В `musl` нет CFI аннотаций для функции возврата из сигнала,
поэтому libunwind не может раскрутить стек выше signal handler-а.
- Не работает вместе с санитайзерами.
- go tool pprof не поддерживает символизацию профиля, потому что он получился не из go программы.
Нужно использовать https://github.com/google/pprof.
- Стектрейс иногда бъётся, когда сигнал прилетел в эпилоге функции. Это ограничение libunwind.

## Memory Profiler

YTProf позволяет экспортировать профиль аллокатора из tcmalloc. При этом, сама библиотека ytprof
не зависит от всего tcmalloc.