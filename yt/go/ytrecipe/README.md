# ytrecipe

ytrecipe - это рецепт для ya make, который позволяет запускать аркадийный тест
внутри YT операции, без изменений в коде самого теста.

## Quick Start

* Создать файл `ytrecipe.yson`  в директории теста.
```
{
    cluster = freud;
    upload_binaries = [
        "yt/go/ytrecipe/test/outputlimit/outputlimit"
    ];
}
```
В списке `upload_binaries` нужно указать исполняемые файлы нужные для работы теста. Путь
до файлов указывается так же, как в аргументе функции `binary_path()` из `yatest.common`.

* Дописать в `ya.make` тестового модуля.
```
SET(YTRECIPE_CONFIG_PATH path/from/root/to/my/test/ytrecipe.yson)
INCLUDE(${ARCADIA_ROOT}/yt/go/ytrecipe/recipe.inc)
```

## Как это работает

В момент запуска, рецепт заливает файлы из локальной файловой системы на YT. После
этого рецепт запускает vanilla операцию. Каждая task-а операции выполняет один тестовый
процесс.

Результаты работы теста пишутся из операции в выходную таблицу, и затем скачиваются
на локальную файловую систему.

## TTL

Рецепт хранит на YT исполняемые файлы и таблицы результатами. TTL и положение этих
файлов настраивается в конфиге.

```
{
    cache_path="//home/yt-integration-tests/cache";
    cache_ttl_hours=24;

    output_path="//home/yt-integration-tests/output";
    output_ttl_hours=168;
}
```

По умолчанию все данные хранятся в `//tmp` с ttl в 1 час.

## Лимиты на CPU и память

Отдельная секция конфига описывает лимиты на потребление памяти. Можно задать лимиты на
CPU и память. Эти лимиты попадут в спеку операции.

```
{
    resource_limits={
        cpu_limit=10;
        memory_limit=20000000000;
    };
}
```

## Сохранение логов

- Рецепт автоматом скачивает output директорию теста, после завершения операции. Так что логи сохраняются в CI.
- Work директория теста никогда не сохраняется.
- Во время работы, тесту доступна особая директория `/slot/sandbox/ytrecipe_output`. Все
файлы из этой директории сохраняются в таблицу YT, но не скачиваются на distbuild. Эту директорию
можно скачать с YT потом, когда нужно будет отлаживать тест. Команда для скачивания
пишется в файл `README.md` в output директории теста.
- `core`-файлы появившиеся во время работы теста сохраняются в директорию `ytrecipe_output`.
В файле `README.md` можно найти список исполняемых файлов и команды для скачивания этих
файлов с YT.

## tmpfs и OOM

Тест запускается в базовом образе, который расположен на диске. Все остальные файлы
хранятся в tmpfs. В tmpfs хранятся исполняемые файлы, логи, `ytrecipe_output`.

Потребление памяти внутри этого tmpfs засчитывается в общий лимит на память.

Тест запускается в контейнере с `controller=memory` и лимитом равным лимиту из конфига.
