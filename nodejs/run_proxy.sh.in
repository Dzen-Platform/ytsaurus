#!/bin/bash

CMB=@CMAKE_CURRENT_BINARY_DIR@
CMS=@CMAKE_CURRENT_SOURCE_DIR@

[[ -f $CMB/Makefile ]] && make cmake_check_build_system || (echo "Re-run $0" && exit)
[[ ! -L $CMS/lib/ytnode.node ]] && ln -s $CMB/ytnode.node $CMS/lib

export NODE_PATH=$CMB/node_modules:$NODE_PATH

(cd $CMB && npm install)

[[ ! -L $CMB/node_modules/yt ]] && ln -s $CMS $CMB/node_modules/yt

if [[ -f /usr/lib/libjemalloc.so.1 ]]; then
    export LD_PRELOAD=/usr/lib/libjemalloc.so.1
    export MALLOC_CONF=prof_prefix:yt_http_proxy_jemalloc
fi

cd $CMB && exec $CMB/node_modules/yt/bin/yt_http_proxy "$@"
